name: Build and Release Cilium

on:
  push:
    branches:
      - main  # Trigger the workflow when pushing to main branch

jobs:
  build-and-release:
    name: Build and Release for ARM and AMD
    runs-on: ubuntu-latest

    steps:
    # Checkout the code
    - name: Checkout Code
      uses: actions/checkout@v3

    # Set up Go environment
    - name: Set Up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.19  # Specify the Go version required for Cilium

    # Install build dependencies
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang llvm make gcc bpfcc-tools

    # Build for AMD architecture
    - name: Build for AMD64
      run: |
        make clean
        GOARCH=amd64 make
        tar -czf cilium-linux-amd64.tar.gz cilium
        sha256sum cilium-linux-amd64.tar.gz > cilium-linux-amd64.tar.gz.sha256sum

    # Build for ARM architecture
    - name: Build for ARM64
      run: |
        make clean
        GOARCH=arm64 make
        tar -czf cilium-linux-arm64.tar.gz cilium
        sha256sum cilium-linux-arm64.tar.gz > cilium-linux-arm64.tar.gz.sha256sum

    # Upload all files as release artifacts
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: cilium-release
        path: |
          cilium-linux-amd64.tar.gz
          cilium-linux-amd64.tar.gz.sha256sum
          cilium-linux-arm64.tar.gz
          cilium-linux-arm64.tar.gz.sha256sum

    # Create a GitHub release
    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: |
          cilium-linux-amd64.tar.gz
          cilium-linux-amd64.tar.gz.sha256sum
          cilium-linux-arm64.tar.gz
          cilium-linux-arm64.tar.gz.sha256sum
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: v${{ github.run_number }}
        releaseName: Cilium v${{ github.run_number }}
        generateReleaseNotes: true
